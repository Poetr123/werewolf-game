<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Werewolf Game - Supabase</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #16213e;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .page {
            display: none;
            padding: 20px;
        }

        .page.active {
            display: block;
        }

        h1, h2, h3 {
            color: #e94560;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #0f3460;
            color: white;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #e94560;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #b83651;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .player-list {
            margin: 20px 0;
            border: 1px solid #0f3460;
            border-radius: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .player-item {
            padding: 10px;
            margin-bottom: 5px;
            background-color: #0f3460;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .host-badge {
            background-color: #e94560;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #0f3460;
            border-radius: 5px;
        }

        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #e94560;
        }

        .phase {
            font-size: 18px;
            font-weight: bold;
        }

        .chat-container {
            border: 1px solid #0f3460;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #0f3460;
            border-radius: 5px;
        }

        .action-container {
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .vote-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .vote-option {
            padding: 10px 15px;
            background-color: #0f3460;
            border-radius: 5px;
            cursor: pointer;
        }

        .vote-option:hover {
            background-color: #e94560;
        }

        .error-message {
            color: #e94560;
            margin-top: 10px;
        }

        .role-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #0f3460;
            border-radius: 5px;
        }

        .player-dead {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }

        .status-success {
            background-color: #4caf50;
        }

        .status-error {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Halaman Login -->
        <div id="login-page" class="page active">
            <h1>Werewolf Game</h1>
            <div class="form-group">
                <input type="text" id="username-input" placeholder="Username (3-10 karakter)" maxlength="10">
            </div>
            <button id="login-btn">Masuk</button>
            <p id="login-error" class="error-message"></p>
        </div>

        <!-- Halaman Lobi -->
        <div id="lobby-page" class="page">
            <h2>Lobi Game</h2>
            <div class="form-group">
                <button id="create-room-btn">Buat Room</button>
            </div>
            <div class="form-group">
                <input type="text" id="room-code-input" placeholder="Kode Room">
                <button id="join-room-btn">Gabung Room</button>
            </div>
            <div id="status-message" class="status-message" style="display: none;"></div>
            <div id="room-list" class="player-list">
                <!-- Daftar room akan ditampilkan di sini -->
            </div>
        </div>

        <!-- Halaman Room -->
        <div id="room-page" class="page">
            <h2>Room: <span id="room-code"></span></h2>
            <div class="form-group">
                <button id="start-game-btn" disabled>Mulai Game</button>
                <button id="leave-room-btn">Keluar Room</button>
            </div>
            <div id="players-list" class="player-list">
                <!-- Daftar pemain akan ditampilkan di sini -->
            </div>
        </div>

        <!-- Halaman Game -->
        <div id="game-page" class="page">
            <div class="game-info">
                <div class="phase" id="phase-display">Malam</div>
                <div class="timer" id="timer-display">75</div>
            </div>
            
            <div id="player-list-game" class="player-list">
                <!-- Daftar pemain dalam game -->
            </div>
            
            <div id="chat-container" class="chat-container">
                <!-- Pesan chat akan ditampilkan di sini -->
            </div>
            
            <div class="form-group">
                <input type="text" id="chat-input" placeholder="Ketik pesan..." disabled>
                <button id="send-chat-btn" disabled>Kirim</button>
            </div>
            
            <div id="action-container" class="action-container">
                <!-- Area aksi berdasarkan peran -->
            </div>
            
            <div id="vote-container" class="vote-container">
                <!-- Area voting -->
            </div>
            
            <div id="role-info" class="role-info">
                <!-- Informasi peran pemain -->
            </div>
        </div>
    </div>

    <script>
        // Inisialisasi Supabase
        const SUPABASE_URL = 'https://nmcwvlaytdxivfmbzsnl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tY3d2bGF5dGR4aXZmbWJ6c25sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODcxNTMsImV4cCI6MjA3MjY2MzE1M30.Z6qBoi5L8E3pPjD-U8Er0pDLIRvipkL0lXOem0Gz8cE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variabel global
        let currentUser = null;
        let currentRoom = null;
        let gameState = null;
        let players = [];
        let gameInterval = null;
        let chatMessages = [];
        let roomSubscription = null;
        let gameSubscription = null;

        // Elemen DOM
        const loginPage = document.getElementById('login-page');
        const lobbyPage = document.getElementById('lobby-page');
        const roomPage = document.getElementById('room-page');
        const gamePage = document.getElementById('game-page');

        const usernameInput = document.getElementById('username-input');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');

        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const roomCodeInput = document.getElementById('room-code-input');
        const statusMessage = document.getElementById('status-message');

        const roomCodeDisplay = document.getElementById('room-code');
        const startGameBtn = document.getElementById('start-game-btn');
        const leaveRoomBtn = document.getElementById('leave-room-btn');

        const playersList = document.getElementById('players-list');
        const playersListGame = document.getElementById('player-list-game');

        const phaseDisplay = document.getElementById('phase-display');
        const timerDisplay = document.getElementById('timer-display');

        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');

        const actionContainer = document.getElementById('action-container');
        const voteContainer = document.getElementById('vote-container');
        const roleInfo = document.getElementById('role-info');

        // Inisialisasi event listeners
        document.addEventListener('DOMContentLoaded', () => {
            loginBtn.addEventListener('click', handleLogin);
            createRoomBtn.addEventListener('click', createRoom);
            joinRoomBtn.addEventListener('click', joinRoom);
            startGameBtn.addEventListener('click', startGame);
            leaveRoomBtn.addEventListener('click', leaveRoom);
            sendChatBtn.addEventListener('click', sendChat);
            
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChat();
                }
            });
            
            // Cek apakah sudah login
            const savedUser = localStorage.getItem('werewolf_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showLobby();
            }
        });

        // Fungsi untuk handle login
        function handleLogin() {
            const username = usernameInput.value.trim();
            
            if (username.length < 3 || username.length > 10) {
                loginError.textContent = 'Username harus 3-10 karakter';
                return;
            }
            
            currentUser = {
                id: generateId(),
                username: username
            };
            
            // Simpan user ke localStorage
            localStorage.setItem('werewolf_user', JSON.stringify(currentUser));
            
            showLobby();
        }

        // Fungsi untuk membuat room
        async function createRoom() {
            try {
                const roomCode = generateRoomCode();
                
                // Insert room ke Supabase
                const { data, error } = await supabase
                    .from('rooms')
                    .insert([
                        { 
                            code: roomCode, 
                            host_id: currentUser.id, 
                            status: 'waiting',
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select();
                
                if (error) throw error;
                
                currentRoom = data[0];
                
                // Gabung ke room
                await joinRoom(roomCode);
                
            } catch (error) {
                showStatus('Error creating room: ' + error.message, 'error');
                console.error('Error creating room:', error);
            }
        }

        // Fungsi untuk bergabung dengan room
        async function joinRoom(code = null) {
            const roomCode = code ? code.trim() : roomCodeInput.value.trim();
            if (!roomCode) {
            showStatus('Masukkan kode room', 'error');
              return;
        }    
            try {
                // Cek apakah room ada
                const { data: roomData, error: roomError } = await supabase
                    .from('rooms')
                    .select('*')
                    .eq('code', roomCode)
                    .single();
                
                if (roomError) throw roomError;
                if (!roomData) {
                    showStatus('Room tidak ditemukan', 'error');
                    return;
                }
                
                // Cek apakah room penuh
                const { data: playersData, error: playersError } = await supabase
                    .from('room_players')
                    .select('*')
                    .eq('room_code', roomCode);
                
                if (playersError) throw playersError;
                
                if (playersData.length >= 10) {
                    showStatus('Room sudah penuh', 'error');
                    return;
                }
                
                // Cek apakah pemain sudah ada di room
                const existingPlayer = playersData.find(p => p.player_id === currentUser.id);
                if (existingPlayer) {
                    // Pemain sudah ada di room, lanjutkan
                    currentRoom = roomData;
                    showRoom();
                    return;
                }
                
                // Tambahkan pemain ke room
                const { error: insertError } = await supabase
                    .from('room_players')
                    .insert([
                        { 
                            room_code: roomCode, 
                            player_id: currentUser.id, 
                            username: currentUser.username,
                            joined_at: new Date().toISOString()
                        }
                    ]);
                
                if (insertError) throw insertError;
                
                currentRoom = roomData;
                showRoom();
                showStatus('Berhasil bergabung dengan room', 'success');
                
            } catch (error) {
                showStatus('Error joining room: ' + error.message, 'error');
                console.error('Error joining room:', error);
            }
        }

        // Fungsi untuk meninggalkan room
        async function leaveRoom() {
            if (!currentRoom) return;
            
            try {
                // Hapus pemain dari room_players
                const { error } = await supabase
                    .from('room_players')
                    .delete()
                    .eq('room_code', currentRoom.code)
                    .eq('player_id', currentUser.id);
                
                if (error) throw error;
                
                // Jika host keluar, hapus room
                if (currentRoom.host_id === currentUser.id) {
                    await supabase
                        .from('rooms')
                        .delete()
                        .eq('code', currentRoom.code);
                }
                
                // Unsubscribe dari room changes
                if (roomSubscription) {
                    supabase.removeChannel(roomSubscription);
                    roomSubscription = null;
                }
                
                currentRoom = null;
                showLobby();
                
            } catch (error) {
                showStatus('Error leaving room: ' + error.message, 'error');
                console.error('Error leaving room:', error);
            }
        }

        // Fungsi untuk memulai game
        async function startGame() {
            if (!currentRoom || currentRoom.host_id !== currentUser.id) return;
            
            try {
                // Perbarui status room
                const { error } = await supabase
                    .from('rooms')
                    .update({ status: 'playing' })
                    .eq('code', currentRoom.code);
                
                if (error) throw error;
                
                // Inisialisasi game state
                await initializeGameState();
                
                showGame();
                startGameLoop();
                
            } catch (error) {
                showStatus('Error starting game: ' + error.message, 'error');
                console.error('Error starting game:', error);
            }
        }

        // Fungsi untuk inisialisasi state game
        async function initializeGameState() {
            try {
                // Dapatkan semua pemain di room
                const { data: playersData, error } = await supabase
                    .from('room_players')
                    .select('*')
                    .eq('room_code', currentRoom.code);
                
                if (error) throw error;
                
                players = playersData;
                
                // Tentukan komposisi peran berdasarkan jumlah pemain
                const roles = determineRoles(players.length);
                
                // Acak peran untuk pemain
                const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);
                
                // Buat game state
                gameState = {
                    phase: 'night',
                    day: 1,
                    timer: 75,
                    players: shuffledPlayers.map((player, index) => ({
                        ...player,
                        role: roles[index],
                        alive: true,
                        voted: null,
                        protected: false,
                        // Tambahan properti berdasarkan peran
                        seerChances: roles[index] === 'dukun' ? 2 : 0,
                        banditChances: roles[index] === 'bandit' ? 2 : 0,
                        banditMarked: null,
                        witchRevived: false
                    })),
                    // Properti tambahan untuk game state
                    votes: {},
                    actions: {}
                };
                
                // Simpan game state ke Supabase
                const { error: saveError } = await supabase
                    .from('game_states')
                    .insert([
                        {
                            room_code: currentRoom.code,
                            state: gameState,
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (saveError) throw saveError;
                
            } catch (error) {
                console.error('Error initializing game state:', error);
                throw error;
            }
        }

        // Fungsi untuk menentukan peran berdasarkan jumlah pemain
        function determineRoles(playerCount) {
            const roles = [];
            
            if (playerCount === 5) {
                roles.push('werewolf', 'netral', 'warga', 'warga', 'warga');
            } else if (playerCount === 6) {
                roles.push('werewolf', 'netral', 'warga', 'warga', 'warga', 'penjaga');
            } else if (playerCount === 7) {
                roles.push('werewolf', 'netral', 'warga', 'warga', 'warga', 'penjaga', 'pemburu');
            } else if (playerCount === 8) {
                roles.push('werewolf', 'netral', 'warga', 'warga', 'warga', 'penjaga', 'pemburu', 'dukun');
            } else if (playerCount === 9) {
                roles.push('werewolf', 'netral', 'netral', 'warga', 'warga', 'warga', 'penjaga', 'pemburu', 'dukun');
            } else if (playerCount === 10) {
                roles.push('werewolf', 'werewolf', 'netral', 'netral', 'warga', 'warga', 'warga', 'penjaga', 'pemburu', 'dukun');
            }
            
            return roles;
        }

        // Fungsi untuk memulai game loop
        function startGameLoop() {
            if (gameInterval) clearInterval(gameInterval);
            
            gameInterval = setInterval(async () => {
                try {
                    // Update game state
                    await updateGameState();
                    
                    // Update UI game
                    updateGameUI();
                    
                    // Periksa kondisi menang
                    if (checkWinCondition()) {
                        endGame();
                    }
                } catch (error) {
                    console.error('Error in game loop:', error);
                }
            }, 1000);
        }

        // Fungsi untuk update game state
        async function updateGameState() {
            if (!gameState) return;
            
            // Kurangi timer
            gameState.timer--;
            
            if (gameState.timer <= 0) {
                // Pindah ke fase berikutnya
                await advancePhase();
            }
            
            // Simpan perubahan ke Supabase
            const { error } = await supabase
                .from('game_states')
                .update({ state: gameState })
                .eq('room_code', currentRoom.code);
            
            if (error) throw error;
        }

        // Fungsi untuk maju ke fase berikutnya
        async function advancePhase() {
            switch (gameState.phase) {
                case 'night':
                    gameState.phase = 'morning';
                    gameState.timer = 15; // Waktu untuk melihat hasil
                    processNightActions();
                    break;
                case 'morning':
                    gameState.phase = 'day';
                    gameState.timer = 75; // Waktu diskusi
                    enableChat();
                    break;
                case 'day':
                    gameState.phase = 'evening';
                    gameState.timer = 15; // Waktu voting
                    disableChat();
                    setupVoting();
                    break;
                case 'evening':
                    processVotes();
                    gameState.phase = 'night';
                    gameState.day++;
                    gameState.timer = 75; // Waktu aksi malam
                    resetPlayerStates();
                    setupNightActions();
                    break;
            }
            
            // Simpan perubahan fase ke Supabase
            const { error } = await supabase
                .from('game_states')
                .update({ state: gameState })
                .eq('room_code', currentRoom.code);
            
            if (error) throw error;
        }

        // Fungsi untuk memproses aksi malam
        function processNightActions() {
            // Implementasi pemrosesan aksi berdasarkan peran
            // Werewolf membunuh, Penjaga melindungi, dll.
            addChatMessage("Sistem", "Malam telah berlalu...");
        }

        // Fungsi untuk memproses voting
        function processVotes() {
            // Hitung suara dan tentukan siapa yang dieliminasi
            addChatMessage("Sistem", "Pemungutan suara selesai...");
        }

        // Fungsi untuk mereset state pemain
        function resetPlayerStates() {
            gameState.players.forEach(player => {
                player.voted = null;
                player.protected = false;
                // Reset state lainnya berdasarkan peran
            });
            
            gameState.votes = {};
            gameState.actions = {};
        }

        // Fungsi untuk mengatur aksi malam
        function setupNightActions() {
            actionContainer.innerHTML = '';
            
            const currentPlayer = gameState.players.find(p => p.player_id === currentUser.id);
            if (!currentPlayer || !currentPlayer.alive) return;
            
            // Tampilkan aksi berdasarkan peran
            switch (currentPlayer.role) {
                case 'werewolf':
                    renderWerewolfActions(currentPlayer);
                    break;
                case 'penjaga':
                    renderGuardActions(currentPlayer);
                    break;
                case 'dukun':
                    renderSeerActions(currentPlayer);
                    break;
                case 'bandit':
                    renderBanditActions(currentPlayer);
                    break;
                case 'penyihir':
                    renderWitchActions(currentPlayer);
                    break;
                default:
                    actionContainer.innerHTML = '<p>Tidak ada aksi yang tersedia untuk peran Anda.</p>';
                    break;
            }
        }

        // Fungsi untuk render aksi werewolf
        function renderWerewolfActions(player) {
            actionContainer.innerHTML = '<h3>Pilih target untuk dibunuh:</h3>';
            
            gameState.players.forEach(target => {
                if (target.alive && target.role !== 'werewolf') {
                    const button = document.createElement('button');
                    button.textContent = target.username;
                    button.addEventListener('click', () => {
                        performAction(player, 'kill', target.player_id);
                        button.disabled = true;
                    });
                    actionContainer.appendChild(button);
                }
            });
        }

        // Fungsi untuk melakukan aksi
        async function performAction(player, actionType, targetId) {
            try {
                // Simpan aksi player ke Supabase
                const { error } = await supabase
                    .from('player_actions')
                    .insert([
                        {
                            room_code: currentRoom.code,
                            player_id: player.player_id,
                            action: actionType,
                            target_id: targetId,
                            day: gameState.day,
                            phase: gameState.phase
                        }
                    ]);
                
                if (error) throw error;
                
                // Simpan di state lokal juga
                if (!gameState.actions[player.player_id]) {
                    gameState.actions[player.player_id] = [];
                }
                
                gameState.actions[player.player_id].push({
                    type: actionType,
                    target: targetId,
                    phase: gameState.phase,
                    day: gameState.day
                });
                
                addChatMessage("Sistem", `${player.username} telah melakukan aksi.`);
                
            } catch (error) {
                console.error('Error performing action:', error);
            }
        }

        // Fungsi untuk mengatur voting
        function setupVoting() {
            voteContainer.innerHTML = '<h3>Pilih pemain untuk dieliminasi:</h3>';
            
            const currentPlayer = gameState.players.find(p => p.player_id === currentUser.id);
            if (!currentPlayer || !currentPlayer.alive) return;
            
            gameState.players.forEach(target => {
                if (target.alive && target.player_id !== currentPlayer.player_id) {
                    const option = document.createElement('div');
                    option.className = 'vote-option';
                    option.textContent = target.username;
                    option.addEventListener('click', () => {
                        votePlayer(currentPlayer, target.player_id);
                        option.style.backgroundColor = '#e94560';
                    });
                    voteContainer.appendChild(option);
                }
            });
        }

        // Fungsi untuk voting
        async function votePlayer(player, targetId) {
            try {
                player.voted = targetId;
                
                if (!gameState.votes[targetId]) {
                    gameState.votes[targetId] = 0;
                }
                
                gameState.votes[targetId]++;
                
                // Simpan vote ke Supabase
                const { error } = await supabase
                    .from('player_votes')
                    .insert([
                        {
                            room_code: currentRoom.code,
                            player_id: player.player_id,
                            target_id: targetId,
                            day: gameState.day
                        }
                    ]);
                
                if (error) throw error;
                
                addChatMessage("Sistem", `${player.username} telah memilih.`);
                
            } catch (error) {
                console.error('Error voting:', error);
            }
        }

        // Fungsi untuk mengaktifkan chat
        function enableChat() {
            chatInput.disabled = false;
            sendChatBtn.disabled = false;
        }

        // Fungsi untuk menonaktifkan chat
        function disableChat() {
            chatInput.disabled = true;
            sendChatBtn.disabled = true;
        }

        // Fungsi untuk mengirim chat
        async function sendChat() {
            const message = chatInput.value.trim();
            
            if (message && currentUser) {
                try {
                    // Simpan chat ke Supabase
                    const { error } = await supabase
                        .from('chat_messages')
                        .insert([
                            {
                                room_code: currentRoom.code,
                                player_id: currentUser.id,
                                username: currentUser.username,
                                message: message,
                                sent_at: new Date().toISOString()
                            }
                        ]);
                    
                    if (error) throw error;
                    
                    // Tambahkan ke UI
                    addChatMessage(currentUser.username, message);
                    chatInput.value = '';
                    
                } catch (error) {
                    console.error('Error sending chat:', error);
                }
            }
        }

        // Fungsi untuk menambah pesan chat
        function addChatMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            chatMessages.push({ sender, message });
        }

        // Fungsi untuk update UI game
        function updateGameUI() {
            if (!gameState) return;
            
            // Update tampilan fase dan timer
            phaseDisplay.textContent = getPhaseName(gameState.phase);
            timerDisplay.textContent = gameState.timer;
            
            // Update daftar pemain
            updateGamePlayersList();
            
            // Update informasi peran
            updateRoleInfo();
        }

        // Fungsi untuk mendapatkan nama fase
        function getPhaseName(phase) {
            const phases = {
                'night': 'Malam',
                'morning': 'Pagi',
                'day': 'Siang',
                'evening': 'Sore'
            };
            return phases[phase] || phase;
        }

        // Fungsi untuk update daftar pemain di game
        function updateGamePlayersList() {
            playersListGame.innerHTML = '';
            
            gameState.players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${player.alive ? '' : 'player-dead'}`;
                
                let roleText = '';
                if (!player.alive || player.player_id === currentUser.id) {
                    roleText = `<span>(${getRoleName(player.role)})</span>`;
                }
                
                playerItem.innerHTML = `
                    <span>${player.username}</span>
                    ${roleText}
                `;
                
                playersListGame.appendChild(playerItem);
            });
        }

        // Fungsi untuk mendapatkan nama peran
        function getRoleName(role) {
            const roles = {
                'warga': 'Warga Biasa',
                'penjaga': 'Penjaga',
                'pemburu': 'Pemburu',
                'dukun': 'Dukun',
                'werewolf': 'Werewolf',
                'bandit': 'Bandit',
                'penyihir': 'Penyihir',
                'netral': 'Netral'
            };
            return roles[role] || role;
        }

        // Fungsi untuk update informasi peran
        function updateRoleInfo() {
            const currentPlayer = gameState.players.find(p => p.player_id === currentUser.id);
            
            if (!currentPlayer) return;
            
            let roleDescription = '';
            
            switch (currentPlayer.role) {
                case 'warga':
                    roleDescription = 'Anda adalah Warga Biasa. Tidak memiliki kemampuan khusus. Tugas Anda adalah membantu menemukan dan mengeliminasi Werewolf.';
                    break;
                case 'penjaga':
                    roleDescription = 'Anda adalah Penjaga. Setiap malam, Anda dapat melindungi satu pemain dari serangan Werewolf. Jika tidak memilih, Anda akan melindungi diri sendiri.';
                    break;
                case 'pemburu':
                    roleDescription = 'Anda adalah Pemburu. Anda dapat memilih satu pemain untuk ditembak. Jika target adalah Innocent, Anda akan ikut mati.';
                    break;
                case 'dukun':
                    roleDescription = `Anda adalah Dukun. Anda memiliki ${currentPlayer.seerChances} kesempatan untuk meramal identitas pemain lain.`;
                    break;
                case 'werewolf':
                    roleDescription = 'Anda adalah Werewolf. Setiap malam, Anda dapat membunuh satu pemain. Tujuan Anda adalah menghabisi semua pemain non-Werewolf.';
                    break;
                case 'bandit':
                    roleDescription = `Anda adalah Bandit. Anda memiliki ${currentPlayer.banditChances} kesempatan untuk memberi tanda pada pemain. Pemain yang ditandai akan mati jika menggunakan skill.`;
                    break;
                case 'penyihir':
                    roleDescription = 'Anda adalah Penyihir. Anda dapat menghidupkan kembali pemain yang telah mati. Pemain yang dihidupkan akan menjadi pembantu Anda.';
                    break;
                case 'netral':
                    roleDescription = 'Anda adalah Netral. Tujuan Anda bergantung pada peran spesifik Anda.';
                    break;
            }
            
            roleInfo.innerHTML = `
                <h3>Peran Anda: ${getRoleName(currentPlayer.role)}</h3>
                <p>${roleDescription}</p>
            `;
        }

        // Fungsi untuk memeriksa kondisi menang
        function checkWinCondition() {
            // Implementasi pengecekan kondisi menang
            return false;
        }

        // Fungsi untuk mengakhiri game
        function endGame() {
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            
            // Unsubscribe dari game changes
            if (gameSubscription) {
                supabase.removeChannel(gameSubscription);
                gameSubscription = null;
            }
            
            // Tampilkan hasil game
            alert('Game berakhir!');
            
            // Kembali ke lobi
            showLobby();
        }

        // Fungsi untuk menampilkan halaman login
        function showLogin() {
            hideAllPages();
            loginPage.classList.add('active');
        }

        // Fungsi untuk menampilkan halaman lobi
        function showLobby() {
            hideAllPages();
            lobbyPage.classList.add('active');
            updateRoomsList();
            
            // Subscribe untuk mendapatkan update room
            subscribeToRooms();
        }

        // Fungsi untuk menampilkan halaman room
        function showRoom() {
            hideAllPages();
            roomPage.classList.add('active');
            
            roomCodeDisplay.textContent = currentRoom.code;
            updatePlayersList();
            
            // Enable/disable start button berdasarkan jumlah pemain
            startGameBtn.disabled = currentRoom.players.length < 5 || currentRoom.players.length > 10 || currentRoom.host_id !== currentUser.id;
            
            // Subscribe untuk mendapatkan update pemain di room
            subscribeToRoomPlayers();
        }

        // Fungsi untuk menampilkan halaman game
        function showGame() {
            hideAllPages();
            gamePage.classList.add('active');
            
            // Setup awal game
            updateGameUI();
            setupNightActions();
            
            // Subscribe untuk mendapatkan update game state
            subscribeToGameState();
            
            // Subscribe untuk mendapatkan update chat
            subscribeToChat();
        }

        // Fungsi untuk menyembunyikan semua halaman
        function hideAllPages() {
            loginPage.classList.remove('active');
            lobbyPage.classList.remove('active');
            roomPage.classList.remove('active');
            gamePage.classList.remove('active');
        }

        // Fungsi untuk update daftar pemain di room
        async function updatePlayersList() {
            try {
                const { data: players, error } = await supabase
                    .from('room_players')
                    .select('*')
                    .eq('room_code', currentRoom.code);
                
                if (error) throw error;
                
                playersList.innerHTML = '';
                
                players.forEach(player => {
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-item';
                    
                    const isHost = currentRoom.host_id === player.player_id;
                    playerItem.innerHTML = `
                        <span>${player.username}</span>
                        ${isHost ? '<span class="host-badge">Host</span>' : ''}
                    `;
                    
                    playersList.appendChild(playerItem);
                });
                
                // Enable/disable start button berdasarkan jumlah pemain
                startGameBtn.disabled = players.length < 5 || players.length > 10 || currentRoom.host_id !== currentUser.id;
                
            } catch (error) {
                console.error('Error updating players list:', error);
            }
        }

        // Fungsi untuk update daftar room
        async function updateRoomsList() {
            try {
                const { data: rooms, error } = await supabase
                    .from('rooms')
                    .select('*')
                    .eq('status', 'waiting');
                
                if (error) throw error;
                
                const roomList = document.getElementById('room-list');
                roomList.innerHTML = '';
                
                for (const room of rooms) {
                    // Dapatkan jumlah pemain di room
                    const { data: players, error: playersError } = await supabase
                        .from('room_players')
                        .select('*')
                        .eq('room_code', room.code);
                    
                    if (playersError) throw playersError;
                    
                    const roomItem = document.createElement('div');
                    roomItem.className = 'player-item';
                    roomItem.innerHTML = `
                        <span>Room: ${room.code} (${players.length}/10)</span>
                        <button onclick="joinRoomFromList('${room.code}')">Join</button>
                    `;
                    roomList.appendChild(roomItem);
                }
                
            } catch (error) {
                console.error('Error updating rooms list:', error);
            }
        }

        // Fungsi untuk subscribe ke update room
        function subscribeToRooms() {
            if (roomSubscription) {
                supabase.removeChannel(roomSubscription);
            }
            
            roomSubscription = supabase
                .channel('rooms_channel')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'rooms' 
                    }, 
                    (payload) => {
                        updateRoomsList();
                    }
                )
                .subscribe();
        }

        // Fungsi untuk subscribe ke update pemain di room
        function subscribeToRoomPlayers() {
            if (roomSubscription) {
                supabase.removeChannel(roomSubscription);
            }
            
            roomSubscription = supabase
                .channel('room_players_channel')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'room_players',
                        filter: `room_code=eq.${currentRoom.code}`
                    }, 
                    (payload) => {
                        updatePlayersList();
                    }
                )
                .subscribe();
        }

        // Fungsi untuk subscribe ke update game state
        function subscribeToGameState() {
            if (gameSubscription) {
                supabase.removeChannel(gameSubscription);
            }
            
            gameSubscription = supabase
                .channel('game_state_channel')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'game_states',
                        filter: `room_code=eq.${currentRoom.code}`
                    }, 
                    async (payload) => {
                        // Update game state dari Supabase
                        const { data, error } = await supabase
                            .from('game_states')
                            .select('*')
                            .eq('room_code', currentRoom.code)
                            .order('created_at', { ascending: false })
                            .limit(1)
                            .single();
                        
                        if (!error && data) {
                            gameState = data.state;
                            updateGameUI();
                        }
                    }
                )
                .subscribe();
        }

        // Fungsi untuk subscribe ke update chat
        function subscribeToChat() {
            if (gameSubscription) {
                supabase.removeChannel(gameSubscription);
            }
            
            gameSubscription = supabase
                .channel('chat_channel')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'chat_messages',
                        filter: `room_code=eq.${currentRoom.code}`
                    }, 
                    async (payload) => {
                        // Dapatkan pesan chat terbaru
                        const { data, error } = await supabase
                            .from('chat_messages')
                            .select('*')
                            .eq('room_code', currentRoom.code)
                            .order('sent_at', { ascending: true });
                        
                        if (!error && data) {
                            // Update UI chat
                            chatContainer.innerHTML = '';
                            data.forEach(msg => {
                                addChatMessage(msg.username, msg.message);
                            });
                        }
                    }
                )
                .subscribe();
        }

        // Fungsi untuk bergabung dengan room dari daftar
        function joinRoomFromList(roomCode) {
            roomCodeInput.value = roomCode;
            joinRoom();
        }

        // Fungsi untuk menghasilkan ID unik
        function generateId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // Fungsi untuk menghasilkan kode room acak
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Fungsi untuk menampilkan status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            
            // Sembunyikan setelah 3 detik
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        // Expose fungsi global untuk button HTML
        window.joinRoomFromList = joinRoomFromList;
    </script>
</body>
</html>

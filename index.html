<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Werewolf Game</title>
    <style>
        /* CSS Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #16213e;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        
        h1, h2, h3 {
            color: #f0f0f0;
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #e94560;
            font-size: 2.5rem;
            margin: 20px 0;
        }
        
        .page {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        button {
            background-color: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #b83651;
        }
        
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
            background-color: #0f3460;
            color: white;
            margin: 5px 0;
            width: 100%;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .player-list {
            list-style-type: none;
            margin: 15px 0;
        }
        
        .player-list li {
            padding: 10px;
            background-color: #0f3460;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-code {
            font-size: 1.5rem;
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background-color: #0f3460;
            border-radius: 5px;
            letter-spacing: 3px;
        }
        
        .chat-container {
            margin: 20px 0;
            border: 1px solid #333;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #0f3460;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            background-color: #1a1a2e;
        }
        
        .chat-input input {
            flex: 1;
            margin-right: 10px;
        }
        
        .timer {
            font-size: 1.5rem;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background-color: #0f3460;
            border-radius: 5px;
        }
        
        .vote-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .vote-option {
            padding: 10px;
            background-color: #0f3460;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .vote-option:hover {
            background-color: #e94560;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .role-info {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .game-log {
            margin: 15px 0;
            padding: 10px;
            background-color: #0f3460;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .player-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-alive {
            width: 10px;
            height: 10px;
            background-color: green;
            border-radius: 50%;
        }
        
        .status-dead {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <h1>Werewolf Game</h1>
    
    <!-- Login Page -->
    <div id="login-page" class="page active">
        <div class="container">
            <h2>Masuk ke Game</h2>
            <div class="form-group">
                <input type="text" id="username-input" placeholder="Username (3-10 karakter)" maxlength="10">
            </div>
            <button id="login-btn">Masuk</button>
        </div>
    </div>
    
    <!-- Main Menu Page -->
    <div id="menu-page" class="page">
        <div class="container">
            <h2>Menu Utama</h2>
            <p>Selamat datang, <span id="username-display"></span>!</p>
            <button id="create-room-btn">Buat Room</button>
            <button id="join-room-btn">Join Room</button>
        </div>
    </div>
    
    <!-- Create Room Page -->
    <div id="create-room-page" class="page">
        <div class="container">
            <h2>Buat Room Baru</h2>
            <button id="start-create-room-btn">Buat Room</button>
            <button id="back-from-create-btn">Kembali</button>
        </div>
    </div>
    
    <!-- Join Room Page -->
    <div id="join-room-page" class="page">
        <div class="container">
            <h2>Join Room</h2>
            <div class="form-group">
                <input type="text" id="room-code-input" placeholder="Kode Room">
            </div>
            <button id="join-room-code-btn">Join</button>
            <button id="back-from-join-btn">Kembali</button>
        </div>
    </div>
    
    <!-- Lobby Page -->
    <div id="lobby-page" class="page">
        <div class="container">
            <h2>Lobby</h2>
            <div class="room-code">Kode Room: <span id="room-code-display"></span></div>
            
            <h3>Pemain:</h3>
            <ul id="players-list" class="player-list"></ul>
            
            <div id="host-controls">
                <button id="start-game-btn" disabled>Mulai Game</button>
                <button id="copy-room-code-btn">Salin Kode Room</button>
            </div>
            
            <button id="leave-lobby-btn">Keluar</button>
        </div>
    </div>
    
    <!-- Game Page -->
    <div id="game-page" class="page">
        <div class="container">
            <h2>Werewolf Game</h2>
            <div class="room-code">Kode Room: <span id="game-room-code"></span></div>
            
            <div class="timer" id="phase-timer">Waktu: <span id="time-left">75</span> detik</div>
            
            <div class="game-phase" id="game-phase-display">Fase: Malam</div>
            
            <div class="role-info">
                <h3>Peran Anda: <span id="player-role"></span></h3>
                <p id="role-description"></p>
            </div>
            
            <div id="action-container">
                <h3>Aksi yang Tersedia:</h3>
                <div id="action-buttons" class="action-buttons"></div>
            </div>
            
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Ketik pesan..." disabled>
                    <button id="send-chat-btn" disabled>Kirim</button>
                </div>
            </div>
            
            <div class="game-log">
                <h3>Log Game:</h3>
                <div id="game-log-messages"></div>
            </div>
            
            <button id="leave-game-btn">Keluar Game</button>
        </div>
    </div>

    <script>
        // JavaScript Implementation
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase initialization
            const SUPABASE_URL = 'https://nmcwvlaytdxivfmbzsnl.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tY3d2bGF5dGR4aXZmbWJ6c25sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODcxNTMsImV4cCI6MjA3MjY2MzE1M30.Z6qBoi5L8E3pPjD-U8Er0pDLIRvipkL0lXOem0Gz8cE';
            
            // Initialize Supabase client (you'll need to replace with your actual Supabase credentials)
            const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Global state
            let currentUser = null;
            let currentRoom = null;
            let players = [];
            let gameState = null;
            let playerRole = null;
            let gameInterval = null;
            
            // DOM Elements
            const pages = {
                login: document.getElementById('login-page'),
                menu: document.getElementById('menu-page'),
                createRoom: document.getElementById('create-room-page'),
                joinRoom: document.getElementById('join-room-page'),
                lobby: document.getElementById('lobby-page'),
                game: document.getElementById('game-page')
            };
            
            // Show a specific page and hide others
            function showPage(pageId) {
                Object.values(pages).forEach(page => {
                    page.classList.remove('active');
                });
                pages[pageId].classList.add('active');
            }
            
            // Login functionality
            document.getElementById('login-btn').addEventListener('click', function() {
                const username = document.getElementById('username-input').value.trim();
                
                if (username.length < 3 || username.length > 10) {
                    alert('Username harus antara 3-10 karakter');
                    return;
                }
                
                currentUser = username;
                document.getElementById('username-display').textContent = username;
                showPage('menu');
            });
            
            // Create room functionality
            document.getElementById('create-room-btn').addEventListener('click', function() {
                showPage('create-room');
            });
            
            document.getElementById('start-create-room-btn').addEventListener('click', async function() {
                // Generate a random room code
                const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                try {
                    // Create room in Supabase
                    const { data, error } = await supabase
                        .from('rooms')
                        .insert([
                            { 
                                code: roomCode, 
                                host: currentUser, 
                                players: [currentUser],
                                status: 'waiting'
                            }
                        ])
                        .select();
                    
                    if (error) throw error;
                    
                    currentRoom = roomCode;
                    document.getElementById('room-code-display').textContent = roomCode;
                    showPage('lobby');
                    
                    // Start listening for room updates
                    listenForRoomUpdates();
                } catch (error) {
                    console.error('Error creating room:', error);
                    alert('Gagal membuat room');
                }
            });
            
            // Join room functionality
            document.getElementById('join-room-btn').addEventListener('click', function() {
                showPage('join-room');
            });
            
            document.getElementById('join-room-code-btn').addEventListener('click', async function() {
                const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
                
                if (!roomCode) {
                    alert('Masukkan kode room');
                    return;
                }
                
                try {
                    // Check if room exists
                    const { data, error } = await supabase
                        .from('rooms')
                        .select('*')
                        .eq('code', roomCode)
                        .single();
                    
                    if (error) throw error;
                    
                    if (!data) {
                        alert('Room tidak ditemukan');
                        return;
                    }
                    
                    if (data.status !== 'waiting') {
                        alert('Game sudah dimulai, tidak bisa join');
                        return;
                    }
                    
                    // Add player to room
                    const updatedPlayers = [...data.players, currentUser];
                    
                    const { error: updateError } = await supabase
                        .from('rooms')
                        .update({ players: updatedPlayers })
                        .eq('code', roomCode);
                    
                    if (updateError) throw updateError;
                    
                    currentRoom = roomCode;
                    document.getElementById('room-code-display').textContent = roomCode;
                    showPage('lobby');
                    
                    // Start listening for room updates
                    listenForRoomUpdates();
                } catch (error) {
                    console.error('Error joining room:', error);
                    alert('Gagal join room');
                }
            });
            
            // Back buttons
            document.getElementById('back-from-create-btn').addEventListener('click', function() {
                showPage('menu');
            });
            
            document.getElementById('back-from-join-btn').addEventListener('click', function() {
                showPage('menu');
            });
            
            // Leave lobby
            document.getElementById('leave-lobby-btn').addEventListener('click', async function() {
                try {
                    // Remove player from room
                    const { data: roomData, error: roomError } = await supabase
                        .from('rooms')
                        .select('*')
                        .eq('code', currentRoom)
                        .single();
                    
                    if (roomError) throw roomError;
                    
                    const updatedPlayers = roomData.players.filter(player => player !== currentUser);
                    
                    // If no players left, delete the room
                    if (updatedPlayers.length === 0) {
                        await supabase
                            .from('rooms')
                            .delete()
                            .eq('code', currentRoom);
                    } else {
                        // Update host if the host left
                        let newHost = roomData.host;
                        if (roomData.host === currentUser) {
                            newHost = updatedPlayers[0];
                        }
                        
                        await supabase
                            .from('rooms')
                            .update({ 
                                players: updatedPlayers,
                                host: newHost
                            })
                            .eq('code', currentRoom);
                    }
                    
                    currentRoom = null;
                    showPage('menu');
                } catch (error) {
                    console.error('Error leaving lobby:', error);
                    alert('Gagal keluar dari lobby');
                }
            });
            
            // Copy room code
            document.getElementById('copy-room-code-btn').addEventListener('click', function() {
                navigator.clipboard.writeText(currentRoom);
                alert('Kode room disalin: ' + currentRoom);
            });
            
            // Start game
            document.getElementById('start-game-btn').addEventListener('click', async function() {
                try {
                    // Get current room data
                    const { data: roomData, error: roomError } = await supabase
                        .from('rooms')
                        .select('*')
                        .eq('code', currentRoom)
                        .single();
                    
                    if (roomError) throw roomError;
                    
                    // Check if host
                    if (roomData.host !== currentUser) {
                        alert('Hanya host yang bisa memulai game');
                        return;
                    }
                    
                    // Check player count
                    if (roomData.players.length < 5 || roomData.players.length > 10) {
                        alert('Jumlah pemain harus antara 5-10 orang');
                        return;
                    }
                    
                    // Assign roles based on player count
                    const roles = assignRoles(roomData.players.length);
                    
                    // Initialize game state
                    const newGameState = {
                        phase: 'night',
                        timeLeft: 75,
                        players: roomData.players.map((player, index) => ({
                            name: player,
                            role: roles[index],
                            alive: true,
                            voted: null,
                            actions: {}
                        })),
                        dayNumber: 1,
                        chatMessages: []
                    };
                    
                    // Update room with game state
                    const { error: updateError } = await supabase
                        .from('rooms')
                        .update({ 
                            status: 'playing',
                            game_state: newGameState
                        })
                        .eq('code', currentRoom);
                    
                    if (updateError) throw updateError;
                    
                    // Find current player's role
                    playerRole = newGameState.players.find(p => p.name === currentUser).role;
                    document.getElementById('player-role').textContent = getRoleName(playerRole);
                    document.getElementById('role-description').textContent = getRoleDescription(playerRole);
                    document.getElementById('game-room-code').textContent = currentRoom;
                    
                    showPage('game');
                    updateGameUI(newGameState);
                    
                    // Start game loop
                    startGameLoop();
                } catch (error) {
                    console.error('Error starting game:', error);
                    alert('Gagal memulai game');
                }
            });
            
            // Listen for room updates
            function listenForRoomUpdates() {
                // Set up realtime subscription for room changes
                const subscription = supabase
                    .channel('room-changes')
                    .on('postgres_changes', 
                        { 
                            event: 'UPDATE', 
                            schema: 'public', 
                            table: 'rooms',
                            filter: `code=eq.${currentRoom}`
                        }, 
                        (payload) => {
                            // Update players list
                            updatePlayersList(payload.new.players, payload.new.host);
                            
                            // Enable start game button if enough players and host
                            const startBtn = document.getEFlementById('start-game-btn');
                            if (payload.new.host === currentUser && payload.new.players.length >= 5) {
                                startBtn.disabled = false;
                            } else {
                                startBtn.disabled = true;
                            }
                            
                            // If game started, move to game page
                            if (payload.new.status === 'playing' && payload.new.game_state) {
                                gameState = payload.new.game_state;
                                playerRole = gameState.players.find(p => p.name === currentUser).role;
                                document.getElementById('player-role').textContent = getRoleName(playerRole);
                                document.getElementById('role-description').textContent = getRoleDescription(playerRole);
                                document.getElementById('game-room-code').textContent = currentRoom;
                                
                                showPage('game');
                                updateGameUI(gameState);
                                
                                // Start game loop if not already running
                                if (!gameInterval) {
                                    startGameLoop();
                                }
                            }
                        }
                    )
                    .subscribe();
            }
            
            // Update players list in lobby
            function updatePlayersList(playersList, host) {
                const playersListElement = document.getElementById('players-list');
                playersListElement.innerHTML = '';
                
                playersList.forEach(player => {
                    const li = document.createElement('li');
                    li.textContent = player;
                    
                    if (player === host) {
                        const hostBadge = document.createElement('span');
                        hostBadge.textContent = ' (Host)';
                        hostBadge.style.color = '#e94560';
                        li.appendChild(hostBadge);
                    }
                    
                    playersListElement.appendChild(li);
                });
                
                players = playersList;
            }
            
            // Assign roles based on player count
            function assignRoles(playerCount) {
                const roles = [];
                
                // Base roles for 5 players
                let innocentCount = 3;
                let neutralCount = 1;
                let werewolfCount = 1;
                
                // Adjust for 6-7 players
                if (playerCount >= 6 && playerCount <= 7) {
                    innocentCount += (playerCount - 5);
                    neutralCount += (playerCount - 5);
                }
                
                // Adjust for 8-10 players
                if (playerCount >= 8 && playerCount <= 10) {
                    innocentCount = 6;
                    neutralCount = 2;
                    werewolfCount = 2;
                }
                
                // Add innocent roles
                for (let i = 0; i < innocentCount; i++) {
                    // Distribute special roles among innocent players
                    if (i === 0) roles.push('guardian');
                    else if (i === 1) roles.push('hunter');
                    else if (i === 2) roles.push('seer');
                    else roles.push('villager');
                }
                
                // Add neutral roles
                for (let i = 0; i < neutralCount; i++) {
                    if (i === 0) roles.push('bandit');
                    else roles.push('witch');
                }
                
                // Add werewolf roles
                for (let i = 0; i < werewolfCount; i++) {
                    roles.push('werewolf');
                }
                
                // Shuffle roles
                for (let i = roles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [roles[i], roles[j]] = [roles[j], roles[i]];
                }
                
                return roles;
            }
            
            // Get role name for display
            function getRoleName(role) {
                const roleNames = {
                    'villager': 'Warga Biasa',
                    'guardian': 'Penjaga',
                    'hunter': 'Pemburu',
                    'seer': 'Dukun',
                    'bandit': 'Bandit',
                    'witch': 'Penyihir',
                    'werewolf': 'Werewolf'
                };
                
                return roleNames[role] || role;
            }
            
            // Get role description
            function getRoleDescription(role) {
                const descriptions = {
                    'villager': 'Tidak memiliki skill khusus. Bertahan hidup dan cari tahu siapa werewolf-nya!',
                    'guardian': 'Bisa melindungi satu pemain setiap malam dari serangan werewolf.',
                    'hunter': 'Bisa menembak satu pemain jika merasa yakin dia adalah werewolf. Hati-hati, jika salah, kamu akan ikut mati!',
                    'seer': 'Bisa meramal identitas pemain lain (2x kesempatan).',
                    'bandit': 'Beri tanda pada pemain lain. Jika pemain yang ditandai menggunakan skill, dia akan mati dan kamu dapat kesempatan tambahan.',
                    'witch': 'Bisa menghidupkan pemain yang telah mati. Pemain yang dihidupkan akan menjadi pembantumu.',
                    'werewolf': 'Bunuh satu pemain setiap malam hingga werewolf mayoritas atau jumlahnya sama dengan innocent.'
                };
                
                return descriptions[role] || '';
            }
            
            // Update game UI based on game state
            function updateGameUI(state) {
                // Update phase display
                document.getElementById('game-phase-display').textContent = `Fase: ${state.phase === 'night' ? 'Malam' : state.phase === 'day' ? 'Siang' : 'Voting'}`;
                
                // Update timer
                document.getElementById('time-left').textContent = state.timeLeft;
                
                // Update action buttons based on phase and role
                updateActionButtons(state);
                
                // Update chat
                updateChat(state.chatMessages);
                
                // Update game log
                updateGameLog(state);
            }
            
            // Update action buttons based on game state and player role
            function updateActionButtons(state) {
                const actionButtons = document.getElementById('action-buttons');
                actionButtons.innerHTML = '';
                
                // Only show actions during appropriate phases
                if (state.phase === 'night') {
                    // Show night actions based on role
                    if (playerRole === 'guardian') {
                        // Guardian can protect someone
                        const select = document.createElement('select');
                        state.players.forEach(player => {
                            if (player.alive) {
                                const option = document.createElement('option');
                                option.value = player.name;
                                option.textContent = player.name;
                                select.appendChild(option);
                            }
                        });
                        
                        const button = document.createElement('button');
                        button.textContent = 'Lindungi';
                        button.addEventListener('click', async () => {
                            // Save protection action
                            await savePlayerAction('protect', select.value);
                        });
                        
                        actionButtons.appendChild(select);
                        actionButtons.appendChild(button);
                    } else if (playerRole === 'werewolf') {
                        // Werewolf can kill someone
                        const select = document.createElement('select');
                        state.players.forEach(player => {
                            if (player.alive && player.name !== currentUser && !player.role.includes('werewolf')) {
                                const option = document.createElement('option');
                                option.value = player.name;
                                option.textContent = player.name;
                                select.appendChild(option);
                            }
                        });
                        
                        const button = document.createElement('button');
                        button.textContent = 'Serang';
                        button.addEventListener('click', async () => {
                            // Save kill action
                            await savePlayerAction('kill', select.value);
                        });
                        
                        actionButtons.appendChild(select);
                        actionButtons.appendChild(button);
                    }
                    // Add other role actions here...
                } else if (state.phase === 'voting') {
                    // Voting phase - players can vote
                    state.players.forEach(player => {
                        if (player.alive && player.name !== currentUser) {
                            const button = document.createElement('button');
                            button.textContent = `Vote ${player.name}`;
                            button.addEventListener('click', async () => {
                                // Save vote
                                await savePlayerAction('vote', player.name);
                            });
                            actionButtons.appendChild(button);
                        }
                    });
                }
            }
            
            // Save player action to database
            async function savePlayerAction(actionType, target) {
                try {
                    // Get current game state
                    const { data: roomData, error: roomError } = await supabase
                        .from('rooms')
                        .select('game_state')
                        .eq('code', currentRoom)
                        .single();
                    
                    if (roomError) throw roomError;
                    
                    // Update player's action
                    const updatedGameState = { ...roomData.game_state };
                    const playerIndex = updatedGameState.players.findIndex(p => p.name === currentUser);
                    
                    if (playerIndex !== -1) {
                        updatedGameState.players[playerIndex].actions[actionType] = target;
                        
                        // Update game state in database
                        const { error: updateError } = await supabase
                            .from('rooms')
                            .update({ game_state: updatedGameState })
                            .eq('code', currentRoom);
                        
                        if (updateError) throw updateError;
                    }
                } catch (error) {
                    console.error('Error saving player action:', error);
                }
            }
            
            // Update chat display
            function updateChat(messages) {
                const chatContainer = document.getElementById('chat-messages');
                chatContainer.innerHTML = '';
                
                messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.textContent = `${msg.player}: ${msg.message}`;
                    chatContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // Update game log
            function updateGameLog(state) {
                const logContainer = document.getElementById('game-log-messages');
                logContainer.innerHTML = '';
                
                // Add phase information
                const phaseInfo = document.createElement('div');
                phaseInfo.textContent = `Hari ${state.dayNumber} - Fase ${state.phase}`;
                logContainer.appendChild(phaseInfo);
                
                // Add player statuses
                state.players.forEach(player => {
                    const playerInfo = document.createElement('div');
                    playerInfo.innerHTML = `<span class="player-status">${player.name} - ${getRoleName(player.role)} <span class="${player.alive ? 'status-alive' : 'status-dead'}"></span></span>`;
                    logContainer.appendChild(playerInfo);
                });
            }
            
            // Start game loop
            function startGameLoop() {
                // Clear any existing interval
                if (gameInterval) {
                    clearInterval(gameInterval);
                }
                
                // Set up game interval to update game state
                gameInterval = setInterval(async () => {
                    try {
                        // Get current game state
                        const { data: roomData, error: roomError } = await supabase
                            .from('rooms')
                            .select('game_state')
                            .eq('code', currentRoom)
                            .single();
                        
                        if (roomError) throw roomError;
                        
                        if (!roomData.game_state) return;
                        
                        // Update timer
                        let updatedGameState = { ...roomData.game_state };
                        updatedGameState.timeLeft -= 1;
                        
                        // If time's up, move to next phase
                        if (updatedGameState.timeLeft <= 0) {
                            updatedGameState = await advanceGamePhase(updatedGameState);
                        }
                        
                        // Update game state in database
                        const { error: updateError } = await supabase
                            .from('rooms')
                            .update({ game_state: updatedGameState })
                            .eq('code', currentRoom);
                        
                        if (updateError) throw updateError;
                        
                        // Update UI
                        updateGameUI(updatedGameState);
                        
                        // Check for win conditions
                        checkWinConditions(updatedGameState);
                    } catch (error) {
                        console.error('Error in game loop:', error);
                    }
                }, 1000);
            }
            
            // Advance to next game phase
            async function advanceGamePhase(state) {
                const newState = { ...state };
                
                if (state.phase === 'night') {
                    // Process night actions
                    processNightActions(newState);
                    
                    // Move to day phase
                    newState.phase = 'day';
                    newState.timeLeft = 75; // 75 seconds for discussion
                } else if (state.phase === 'day') {
                    // Move to voting phase
                    newState.phase = 'voting';
                    newState.timeLeft = 15; // 15 seconds for voting
                } else if (state.phase === 'voting') {
                    // Process votes
                    processVotes(newState);
                    
                    // Move to next night or continue voting if tie
                    if (hasVotingTie(newState)) {
                        // Tie - continue voting with tied players excluded
                        newState.phase = 'voting';
                        newState.timeLeft = 15;
                        resetVotesForTiedPlayers(newState);
                    } else {
                        // No tie - move to night
                        newState.phase = 'night';
                        newState.timeLeft = 75;
                        newState.dayNumber += 1;
                    }
                }
                
                return newState;
            }
            
            // Process night actions
            function processNightActions(state) {
                // This would process all player actions during the night
                // For example: werewolf attacks, guardian protections, etc.
                
                // Placeholder implementation
                state.chatMessages.push({
                    player: 'System',
                    message: 'Malam telah berlalu...'
                });
            }
            
            // Process votes
            function processVotes(state) {
                // Count votes
                const voteCounts = {};
                state.players.forEach(player => {
                    if (player.alive && player.actions.vote) {
                        const votedPlayer = player.actions.vote;
                        voteCounts[votedPlayer] = (voteCounts[votedPlayer] || 0) + 1;
                    }
                });
                
                // Find player with most votes
                let maxVotes = 0;
                let votedOutPlayer = null;
                
                for (const [player, votes] of Object.entries(voteCounts)) {
                    if (votes > maxVotes) {
                        maxVotes = votes;
                        votedOutPlayer = player;
                    }
                }
                
                // Eliminate player if there's a clear majority
                if (votedOutPlayer && maxVotes > 0) {
                    const playerIndex = state.players.findIndex(p => p.name === votedOutPlayer);
                    if (playerIndex !== -1) {
                        state.players[playerIndex].alive = false;
                        state.chatMessages.push({
                            player: 'System',
                            message: `${votedOutPlayer} telah dieliminasi!`
                        });
                    }
                }
                
                // Reset votes for next phase
                state.players.forEach(player => {
                    player.actions.vote = null;
                });
            }
            
            // Check if there's a voting tie
            function hasVotingTie(state) {
                // Count votes
                const voteCounts = {};
                state.players.forEach(player => {
                    if (player.alive && player.actions.vote) {
                        const votedPlayer = player.actions.vote;
                        voteCounts[votedPlayer] = (voteCounts[votedPlayer] || 0) + 1;
                    }
                });
                
                // Find max votes
                const voteValues = Object.values(voteCounts);
                if (voteValues.length === 0) return false;
                
                const maxVotes = Math.max(...voteValues);
                
                // Count how many players have max votes
                let count = 0;
                for (const votes of voteValues) {
                    if (votes === maxVotes) {
                        count++;
                    }
                }
                
                return count > 1;
            }
            
            // Reset votes for tied players
            function resetVotesForTiedPlayers(state) {
                // Count votes
                const voteCounts = {};
                state.players.forEach(player => {
                    if (player.alive && player.actions.vote) {
                        const votedPlayer = player.actions.vote;
                        voteCounts[votedPlayer] = (voteCounts[votedPlayer] || 0) + 1;
                    }
                });
                
                // Find max votes
                const voteValues = Object.values(voteCounts);
                if (voteValues.length === 0) return;
                
                const maxVotes = Math.max(...voteValues);
                
                // Find players with max votes
                const tiedPlayers = [];
                for (const [player, votes] of Object.entries(voteCounts)) {
                    if (votes === maxVotes) {
                        tiedPlayers.push(player);
                    }
                }
                
                // Reset votes for tied players
                state.players.forEach(player => {
                    if (tiedPlayers.includes(player.actions.vote)) {
                        player.actions.vote = null;
                    }
                });
                
                state.chatMessages.push({
                    player: 'System',
                    message: `Vote imbang antara ${tiedPlayers.join(', ')}. Vote ulang!`
                });
            }
            
            // Check win conditions
            function checkWinConditions(state) {
                // Count players by faction
                const factions = {
                    innocent: 0,
                    neutral: 0,
                    werewolf: 0
                };
                
                state.players.forEach(player => {
                    if (player.alive) {
                        if (player.role === 'werewolf') {
                            factions.werewolf++;
                        } else if (['bandit', 'witch'].includes(player.role)) {
                            factions.neutral++;
                        } else {
                            factions.innocent++;
                        }
                    }
                });
                
                // Check werewolf win condition
                if (factions.werewolf >= factions.innocent) {
                    endGame('Werewolf');
                    return;
                }
                
                // Check innocent win condition
                if (factions.werewolf === 0) {
                    endGame('Innocent');
                    return;
                }
                
                // Check individual neutral win conditions
                // This would require more complex logic based on each neutral role's objectives
            }
            
            // End the game
            function endGame(winner) {
                // Clear game interval
                if (gameInterval) {
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
                
                // Show winner
                alert(`Game over! ${winner} menang!`);
                
                // Reset room
                resetRoom();
                
                // Go back to menu
                showPage('menu');
            }
            
            // Reset room after game ends
            async function resetRoom() {
                try {
                    await supabase
                        .from('rooms')
                        .update({ 
                            status: 'waiting',
                            game_state: null
                        })
                        .eq('code', currentRoom);
                } catch (error) {
                    console.error('Error resetting room:', error);
                }
            }
            
            // Leave game button
            document.getElementById('leave-game-btn').addEventListener('click', async function() {
                if (gameInterval) {
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
                
                // Remove player from room
                try {
                    const { data: roomData, error: roomError } = await supabase
                        .from('rooms')
                        .select('*')
                        .eq('code', currentRoom)
                        .single();
                    
                    if (roomError) throw roomError;
                    
                    const updatedPlayers = roomData.players.filter(player => player !== currentUser);
                    
                    // If no players left, delete the room
                    if (updatedPlayers.length === 0) {
                        await supabase
                            .from('rooms')
                            .delete()
                            .eq('code', currentRoom);
                    } else {
                        // Update host if the host left
                        let newHost = roomData.host;
                        if (roomData.host === currentUser) {
                            newHost = updatedPlayers[0];
                        }
                        
                        await supabase
                            .from('rooms')
                            .update({ 
                                players: updatedPlayers,
                                host: newHost,
                                status: updatedPlayers.length < 5 ? 'waiting' : roomData.status,
                                game_state: null
                            })
                            .eq('code', currentRoom);
                    }
                    
                    currentRoom = null;
                    showPage('menu');
                } catch (error) {
                    console.error('Error leaving game:', error);
                    alert('Gagal keluar dari game');
                }
            });
            
            // Initialize the application
            function init() {
                showPage('login');
            }
            
            // Start the application
            init();
        });
    </script>
    
    <!-- Supabase client (you'll need to replace the URL and key with your actual Supabase project details) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</body>
</html>
